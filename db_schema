-- Database Schema untuk Titik Temu (Lost and Found STIS)
-- Import file ini ke phpMyAdmin

CREATE DATABASE IF NOT EXISTS titik_temu;
USE titik_temu;

-- Tabel Users
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nama_lengkap VARCHAR(100) NOT NULL,
    jabatan VARCHAR(50) NOT NULL COMMENT 'Mahasiswa, Dosen, Tendik, Cleaning Service, dll',
    nim_nip VARCHAR(20) NULL COMMENT 'Boleh kosong untuk non-mahasiswa/dosen',
    no_hp VARCHAR(20) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Tabel Laporan
CREATE TABLE laporan (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    tipe ENUM('HILANG', 'TEMUKAN') NOT NULL COMMENT 'HILANG = barang hilang, TEMUKAN = barang ditemukan',
    judul VARCHAR(200) NOT NULL,
    deskripsi TEXT NOT NULL,
    kategori ENUM('ELEKTRONIK', 'ALAT_TULIS', 'AKSESORIS_PRIBADI', 'ALAT_MAKAN', 'DOKUMEN', 'ATRIBUT_KAMPUS', 'LAINNYA') NOT NULL,
    lokasi VARCHAR(200) NOT NULL COMMENT 'Lokasi kejadian (free text)',
    tanggal_kejadian DATE NOT NULL,
    status ENUM('AKTIF', 'SELESAI') DEFAULT 'AKTIF',
    foto_url VARCHAR(500) NULL COMMENT 'URL foto barang (untuk fitur masa depan)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_tipe (tipe),
    INDEX idx_kategori (kategori),
    INDEX idx_status (status),
    INDEX idx_user_id (user_id),
    INDEX idx_tanggal_kejadian (tanggal_kejadian)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Sample Data untuk Testing
-- Password untuk semua user sample: password123 (sudah di-hash dengan BCrypt)

INSERT INTO users (username, email, password, nama_lengkap, jabatan, nim_nip, no_hp) VALUES
('john_doe', 'john@stis.ac.id', '$2a$10$rJ8Z9qZ9Z9Z9Z9Z9Z9Z9ZeN3qZ9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9', 'John Doe', 'Mahasiswa', '222011234', '081234567890'),
('jane_smith', 'jane@stis.ac.id', '$2a$10$rJ8Z9qZ9Z9Z9Z9Z9Z9Z9ZeN3qZ9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9', 'Jane Smith', 'Dosen', '198501012010', '081234567891'),
('budi_cs', 'budi@stis.ac.id', '$2a$10$rJ8Z9qZ9Z9Z9Z9Z9Z9Z9ZeN3qZ9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9Z9', 'Budi Santoso', 'Cleaning Service', NULL, '081234567892');

INSERT INTO laporan (user_id, tipe, judul, deskripsi, kategori, lokasi, tanggal_kejadian, status) VALUES
(1, 'HILANG', 'iPhone 13 Pro Warna Biru', 'Hilang saat di kantin, casing warna hitam ada stiker BTS', 'ELEKTRONIK', 'Kantin STIS', '2025-10-20', 'AKTIF'),
(2, 'TEMUKAN', 'Dompet Kulit Coklat', 'Ditemukan di parkiran, berisi KTM atas nama Ahmad', 'AKSESORIS_PRIBADI', 'Parkiran Motor Gedung A', '2025-10-22', 'AKTIF'),
(3, 'TEMUKAN', 'Jaket Almamater STIS Ukuran L', 'Jaket almamater warna biru ada badge angkatan 62', 'ATRIBUT_KAMPUS', 'Perpustakaan Lantai 2', '2025-10-21', 'AKTIF'),
(1, 'HILANG', 'Tumbler Stainless Warna Pink', 'Tumbler pink ada stiker kucing, merek Termos', 'ALAT_MAKAN', 'Gedung Kuliah Lt 3', '2025-10-23', 'SELESAI');

-- View untuk laporan dengan info user (untuk mempermudah query)
CREATE VIEW v_laporan_detail AS
SELECT
    l.id,
    l.tipe,
    l.judul,
    l.deskripsi,
    l.kategori,
    l.lokasi,
    l.tanggal_kejadian,
    l.status,
    l.foto_url,
    l.created_at,
    l.updated_at,
    u.id as user_id,
    u.nama_lengkap as pelapor_nama,
    u.jabatan as pelapor_jabatan,
    u.no_hp as pelapor_no_hp,
    u.email as pelapor_email
FROM laporan l
INNER JOIN users u ON l.user_id = u.id;